import _Object$keys from'babel-runtime/core-js/object/keys';import _Object$getPrototypeOf from'babel-runtime/core-js/object/get-prototype-of';import _classCallCheck from'babel-runtime/helpers/classCallCheck';import _createClass from'babel-runtime/helpers/createClass';import _possibleConstructorReturn from'babel-runtime/helpers/possibleConstructorReturn';import _inherits from'babel-runtime/helpers/inherits';import _extends from'babel-runtime/helpers/extends';import React from'react';import PropTypes from'prop-types';import{Grid}from'@vx/grid';import{Group}from'@vx/group';import{WithTooltip,withTooltipPropTypes}from'@data-ui/shared';import collectVoronoiData from'../utils/collectVoronoiData';import findClosestDatums from'../utils/findClosestDatums';import shallowCompareObjectEntries from'../utils/shallowCompareObjectEntries';import Voronoi from'./Voronoi';import{componentName,isAxis,isCrossHair,isReferenceLine,isSeries,getChildWithName,numTicksForWidth,numTicksForHeight,propOrFallback,DEFAULT_CHART_MARGIN}from'../utils/chartUtils';import collectScalesFromProps from'../utils/collectScalesFromProps';import getChartDimensions from'../utils/getChartDimensions';import{scaleShape,themeShape}from'../utils/propShapes';export var CONTAINER_TRIGGER='container';export var SERIES_TRIGGER='series';export var VORONOI_TRIGGER='voronoi';var Y_LABEL_OFFSET=.7;export var propTypes=_extends({},withTooltipPropTypes,{ariaLabel:PropTypes.string.isRequired,children:PropTypes.node,disableMouseEvents:PropTypes.bool,eventTrigger:PropTypes.oneOf(['container','series','voronoi']),eventTriggerRefs:PropTypes.func,height:PropTypes.number.isRequired,innerRef:PropTypes.func,margin:PropTypes.shape({top:PropTypes.number,right:PropTypes.number,bottom:PropTypes.number,left:PropTypes.number}),renderTooltip:PropTypes.func,showXGrid:PropTypes.bool,showYGrid:PropTypes.bool,showVoronoi:PropTypes.bool,snapTooltipToDataX:PropTypes.bool,snapTooltipToDataY:PropTypes.bool,theme:themeShape,width:PropTypes.number.isRequired,xScale:scaleShape.isRequired,yScale:scaleShape.isRequired});export var defaultProps={children:null,disableMouseEvents:!1,eventTrigger:'series',eventTriggerRefs:null,innerRef:null,margin:DEFAULT_CHART_MARGIN,renderTooltip:null,showVoronoi:!1,showXGrid:!1,showYGrid:!1,snapTooltipToDataX:!1,snapTooltipToDataY:!1,theme:{}};var getX=function(a){return a&&a.x},getY=function(a){return a&&a.y},XYChart=function(a){function b(a){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||_Object$getPrototypeOf(b)).call(this,a));return c.state=a.renderTooltip?{}:b.getStateFromProps(a),c.getDatumCoords=c.getDatumCoords.bind(c),c.handleClick=c.handleClick.bind(c),c.handleMouseLeave=c.handleMouseLeave.bind(c),c.handleMouseMove=c.handleMouseMove.bind(c),c.handleContainerEvent=c.handleContainerEvent.bind(c),c}return _inherits(b,a),_createClass(b,[{key:'componentDidMount',value:function componentDidMount(){var a=this.props,b=a.renderTooltip,c=a.eventTriggerRefs;!b&&c&&c({mousemove:this.handleMouseMove,mouseleave:this.handleMouseLeave,click:this.handleClick})}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(a){var c=this,d=!1;['width','height','children'].some(function(b){return c.props[b]!==a[b]})&&(d=!0),['margin','xScale','yScale'].some(function(b){return!shallowCompareObjectEntries(c.props[b],a[b])})&&(d=!0),d&&this.setState(b.getStateFromProps(a))}},{key:'getNumTicks',value:function getNumTicks(a,b){var c=this.props.children,d=getChildWithName('XAxis',c),e=getChildWithName('YAxis',c);return{numXTicks:propOrFallback(d&&d.props,'numTicks',numTicksForWidth(a)),numYTicks:propOrFallback(e&&e.props,'numTicks',numTicksForHeight(b))}}},{key:'getDatumCoords',value:function getDatumCoords(a){var b=this.state,c=b.xScale,d=b.yScale,e=b.margin,f={};return a&&(f.x=c(getX(a))+e.left),a&&(f.y=d(getY(a))+e.top),f}},{key:'handleContainerEvent',value:function handleContainerEvent(a){var b=this.state,c=b.xScale,d=b.yScale,e=this.props.children,f=findClosestDatums({children:e,event:a,getX:getX,getY:getY,xScale:c,yScale:d}),g=f.closestDatum,h=f.series;if(g||0<_Object$keys(h).length){a.persist();var i={event:a,datum:g,series:h};'mousemove'===a.type?this.handleMouseMove(i):'click'===a.type&&this.handleClick(i)}}},{key:'handleMouseMove',value:function handleMouseMove(a){var b=this.props,c=b.snapTooltipToDataX,d=b.snapTooltipToDataY,e=b.onMouseMove,f=a.event&&'focus'===a.event.type;if(e){var g=this.getDatumCoords(a.datum),h=g.x,i=g.y;e(_extends({},a,{coords:_extends({},(f||c)&&{x:h},(f||d)&&{y:i},a.coords)}))}}},{key:'handleMouseLeave',value:function handleMouseLeave(a){var b=this.props.onMouseLeave;b&&b(a)}},{key:'handleClick',value:function handleClick(a){var b=this.props,c=b.snapTooltipToDataX,d=b.snapTooltipToDataY,e=b.onClick;if(e){var f=this.getDatumCoords(a.datum);e(_extends({},a,{coords:_extends({x:c?f.x:void 0,y:d?f.y:void 0},a.coords)}))}}},{key:'render',value:function render(){var a=this,c=this.props.renderTooltip;if(c)return React.createElement(WithTooltip,{renderTooltip:c},React.createElement(b,_extends({},this.props,{renderTooltip:null})));var d=this.props,e=d.ariaLabel,f=d.eventTrigger,g=d.children,h=d.showXGrid,i=d.showYGrid,j=d.theme,k=d.height,l=d.width,m=d.innerRef,n=d.tooltipData,o=d.showVoronoi,p=this.state,q=p.innerWidth,r=p.innerHeight,s=p.margin,t=p.voronoiData,u=p.voronoiX,v=p.voronoiY,w=p.xScale,x=p.yScale,y=this.getNumTicks(q,r),z=y.numXTicks,A=y.numYTicks,B=w.barWidth||w.bandwidth&&w.bandwidth()||0,C=[];return 0<q&&0<r&&React.createElement('svg',{"aria-label":e,role:'img',width:l,height:k,ref:m},React.createElement(Group,{left:s.left,top:s.top},(h||i)&&(z||A)&&React.createElement(Grid,{xScale:w,yScale:x,width:q,height:r,numTicksRows:i&&A,numTicksColumns:h&&z,stroke:j.gridStyles&&j.gridStyles.stroke,strokeWidth:j.gridStyles&&j.gridStyles.strokeWidth}),React.Children.map(g,function(b){var c=componentName(b);if(isAxis(c)){var d=c[0].toLowerCase();return React.cloneElement(b,{innerHeight:r,innerWidth:q,labelOffset:'YAxis'===c?Y_LABEL_OFFSET*s[b.props.orientation]:0,numTicks:'XAxis'===c?z:A,scale:'XAxis'===c?w:x,rangePadding:'XAxis'===c?w.offset:null,axisStyles:_extends({},j[d+'AxisStyles'],b.props.axisStyles),tickStyles:_extends({},j[d+'TickStyles'],b.props.tickStyles)})}return isSeries(c)?React.cloneElement(b,{xScale:w,yScale:x,barWidth:B,onClick:b.props.onClick||(b.props.disableMouseEvents?void 0:a.handleClick),onMouseLeave:b.props.onMouseLeave||(b.props.disableMouseEvents?void 0:a.handleMouseLeave),onMouseMove:b.props.onMouseMove||(b.props.disableMouseEvents?void 0:a.handleMouseMove)}):isCrossHair(c)?(C.push(b),null):isReferenceLine(c)?React.cloneElement(b,{xScale:w,yScale:x}):b}),'voronoi'===f&&React.createElement(Voronoi,{data:t,x:u,y:v,width:q,height:r,onClick:this.handleClick,onMouseMove:this.handleMouseMove,onMouseLeave:this.handleMouseLeave,showVoronoi:o}),'container'===f&&React.createElement('rect',{x:0,y:0,width:q,height:r,fill:'transparent',fillOpacity:0,onClick:this.handleContainerEvent,onMouseMove:this.handleContainerEvent,onMouseLeave:this.handleMouseLeave}),n&&0<C.length&&C.map(function(a,b){return React.cloneElement(a,{key:'crosshair-'+b,left:w(getX(n.datum)||0)+(w.bandwidth?w.bandwidth()/2:0),top:x(getY(n.datum)||0),xScale:w,yScale:x})})))}}],[{key:'getStateFromProps',value:function getStateFromProps(a){var b=getChartDimensions(a),c=b.margin,d=b.innerWidth,e=b.innerHeight,f=collectScalesFromProps(a),g=f.xScale,h=f.yScale,i=collectVoronoiData({children:a.children,getX:getX,getY:getY});return{innerHeight:e,innerWidth:d,margin:c,xScale:g,yScale:h,voronoiData:i,voronoiX:function voronoiX(a){return g(getX(a))},voronoiY:function voronoiY(a){return h(getY(a))}}}}]),b}(React.PureComponent);XYChart.propTypes=propTypes,XYChart.defaultProps=defaultProps,XYChart.displayName='XYChart';export default XYChart;